# ansible/playbooks/deploy.yml
- name: Deploy Django Application
  hosts: webservers
  gather_facts: yes
  vars:
    project_dir: "{{ project_dir | default('/opt/my_django_app') }}"
    git_repo: "{{ lookup('env', 'SEMAPHORE_GIT_URL') | default('https://github.com/Plague143/django-autodeploy-repo.git') }}"
    git_branch: "{{ lookup('env', 'SEMAPHORE_GIT_BRANCH') | default('main') }}"
  
  tasks:
    - name: Debug - Show deployment info
      debug:
        msg: |
          Deploying: {{ app_name }}
          Project dir: {{ project_dir }}
          Repo: {{ git_repo }}
          Branch: {{ git_branch }}
    
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
    
    - name: Install Docker and dependencies
      apt:
        name:
          - docker.io
          - docker-compose
          - python3-pip
          - git
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"
    
    - name: Install Docker Python module
      pip:
        name:
          - docker
          - docker-compose
        state: present
    
    - name: Ensure Docker service is running
      systemd:
        name: docker
        state: started
        enabled: yes
    
    - name: Add current user to docker group
      user:
        name: "{{ ansible_user_id | default('root') }}"
        groups: docker
        append: yes
    
    - name: Create project directory
      file:
        path: "{{ project_dir }}"
        state: directory
        mode: '0755'
    
    - name: Copy application files
      copy:
        src: "{{ playbook_dir }}/../../"
        dest: "{{ project_dir }}"
    
    - name: Create .env file
      copy:
        dest: "{{ project_dir }}/.env"
        content: |
          # Django Settings
          DEBUG={{ debug_mode | default('false') }}
          SECRET_KEY={{ django_secret_key | default('django-insecure-default-key-change-me') }}
          ALLOWED_HOSTS={{ app_domain | default('localhost') }}
          
          # Database
          POSTGRES_DB={{ db_name | default('django_db') }}
          POSTGRES_USER={{ db_user | default('django_user') }}
          POSTGRES_PASSWORD={{ db_password | default('django_password') }}
          DATABASE_URL=postgresql://{{ db_user | default('django_user') }}:{{ db_password | default('django_password') }}@postgres:5432/{{ db_name | default('django_db') }}
          
          # Redis
          REDIS_URL=redis://redis:6379/0
    
    - name: Create docker-compose.yml
      copy:
        dest: "{{ project_dir }}/docker-compose.yml"
        content: |
          version: '3.8'
          
          services:
            postgres:
              image: postgres:13
              environment:
                POSTGRES_DB: "{{ db_name | default('django_db') }}"
                POSTGRES_USER: "{{ db_user | default('django_user') }}"
                POSTGRES_PASSWORD: "{{ db_password | default('django_password') }}"
              volumes:
                - postgres_data:/var/lib/postgresql/data
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U {{ db_user | default('django_user') }}"]
                interval: 10s
                timeout: 5s
                retries: 5
          
            redis:
              image: redis:7-alpine
              command: redis-server --appendonly yes
              healthcheck:
                test: ["CMD", "redis-cli", "ping"]
                interval: 10s
                timeout: 5s
                retries: 5
          
            django:
              build:
                context: .
                dockerfile: docker/django/Dockerfile
              command: >
                sh -c "python manage.py migrate &&
                       python manage.py collectstatic --noinput &&
                       gunicorn app.wsgi:application --bind 0.0.0.0:8000 --workers 3"
              volumes:
                - static_volume:/app/static
                - media_volume:/app/media
              environment:
                DEBUG: "{{ debug_mode | default('false') }}"
                SECRET_KEY: "{{ django_secret_key | default('django-insecure-default-key-change-me') }}"
                DATABASE_URL: "postgresql://{{ db_user | default('django_user') }}:{{ db_password | default('django_password') }}@postgres:5432/{{ db_name | default('django_db') }}"
                REDIS_URL: "redis://redis:6379/0"
              depends_on:
                postgres:
                  condition: service_healthy
                redis:
                  condition: service_healthy
              restart: unless-stopped
          
            nginx:
              build:
                context: .
                dockerfile: docker/nginx/Dockerfile
              ports:
                - "{{ nginx_host_port | default('8080') }}:80"
              volumes:
                - static_volume:/app/static
                - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
              depends_on:
                - django
              restart: unless-stopped
          
          volumes:
            postgres_data:
            static_volume:
            media_volume:
    
    - name: Build Docker images
      community.docker.docker_compose_v2:
        project_src: "{{ project_dir }}"
        build: "always"
        state: present
        recreate: "always"
    
    - name: Stop old containers if exist
      community.docker.docker_compose_v2:
        project_src: "{{ project_dir }}"
        state: absent
      ignore_errors: yes
    
    - name: Start application stack
      community.docker.docker_compose_v2:
        project_src: "{{ project_dir }}"
        state: present
        recreate: "always"
    
    - name: Wait for Django to be ready
      wait_for:
        port: 8000
        host: "127.0.0.1"
        delay: 5
        timeout: 120
    
    - name: Run Django migrations
      community.docker.docker_compose_v2:
        project_src: "{{ project_dir }}"
        services: django
        command: python manage.py migrate --noinput
    
    - name: Check application health
      uri:
        url: "http://localhost:{{ nginx_host_port | default('8080') }}/"
        method: GET
        status_code: 200
        timeout: 10
      register: health_check
      until: health_check.status == 200
      retries: 10
      delay: 5
    
    - name: Show deployment success
      debug:
        msg: |
          ‚úÖ Application {{ app_name }} deployed successfully!
          üåê Access: http://localhost:{{ nginx_host_port | default('8080') }}
          üìä Check containers: docker ps
